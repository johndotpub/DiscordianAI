# Combined PR checks - Dependency Review + Copilot Review
# Runs all PR-specific checks in a single workflow for efficiency
name: PR Checks

on:
  pull_request:
    branches: [ main, develop ]
    types: [ opened, synchronize, reopened ]

# Cancel in-progress runs on same PR
concurrency:
  group: pr-checks-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  # Required check - blocks merge if vulnerable dependencies found
  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: high
          allow-licenses: MIT, Apache-2.0, BSD-2-Clause, BSD-3-Clause, ISC, PSF-2.0, Unlicense, LGPL-2.1, LGPL-3.0, MPL-2.0
          comment-summary-in-pr: always
          retry-on-snapshot-warnings: true

  # Optional check - request Copilot review (informational)
  copilot-review:
    name: Copilot Review
    runs-on: ubuntu-latest
    timeout-minutes: 2
    continue-on-error: true  # Don't fail workflow if Copilot unavailable
    steps:
      - name: Request Copilot Review
        uses: actions/github-script@v7
        with:
          script: |
            try {
              await github.rest.pulls.requestReviewers({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.pull_request.number,
                reviewers: ['copilot']
              });
              console.log('Successfully requested Copilot review');
            } catch (error) {
              console.log('Could not request Copilot review:', error.message);
            }

